"""
–¢–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ù–ï–î–ï–õ–¨–ù–û–ô –ø—Ä–æ–≥—Ä–∞–º–º—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ —á–µ—Ä–µ–∑ LLM.
"""
import asyncio
import json
from openai import AsyncOpenAI
from bot.config.settings import settings


# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ OpenAI
client = AsyncOpenAI(
    api_key=settings.PROXY_API_KEY,
    base_url=settings.PROXY_API_URL
)

# –¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
TEST_USER = {
    "goal": "mass_gain",             # mass_gain | weight_loss | maintenance
    "fitness_level": "beginner", # beginner | intermediate | advanced
    "workout_frequency": 3,          # 2 | 3 | 5
    "equipment_type": "gym"          # gym | bodyweight
}


# –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ù–ï–î–ï–õ–¨–ù–û–ô –ø—Ä–æ–≥—Ä–∞–º–º—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
WORKOUT_WEEK_JSON_PROMPT = """
–¢—ã - —ç–ª–∏—Ç–Ω—ã–π —Ñ–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä –∏ –º–µ—Ç–æ–¥–∏—Å—Ç, —Å–æ–∑–¥–∞—é—â–∏–π –ø—Ä–æ–≥—Ä–∞–º–º—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞—É—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - —Å–æ—Å—Ç–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—É—é –ü–û–õ–ù–£–Æ –Ω–µ–¥–µ–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —É—Ä–æ–≤–Ω—é –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∏ —Ü–µ–ª—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.


–í–´–í–û–î–ò –°–¢–†–û–ì–û –í–ê–õ–ò–î–ù–´–ô JSON –∏ –ù–ò–ß–ï–ì–û, –∫—Ä–æ–º–µ JSON, –ø–æ —Å—Ö–µ–º–µ –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ ¬´–§–û–†–ú–ê–¢ –í–´–í–û–î–ê¬ª.

# –í–•–û–î–ù–´–ï –ü–ê–†–ê–ú–ï–¢–†–´
goal: {goal}                      # –æ–¥–Ω–æ –∏–∑: –ø–æ—Ö—É–¥–µ–Ω–∏–µ | –Ω–∞–±–æ—Ä | –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ
experience: {experience}          # –æ–¥–Ω–æ –∏–∑: –Ω–æ–≤–∏—á–æ–∫ | —Å—Ä–µ–¥–Ω–∏–π | –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π
weekly_sessions: {weekly_sessions}# –æ–¥–Ω–æ –∏–∑: 2 | 3 | 5
equipment: {equipment}            # –æ–¥–Ω–æ –∏–∑: gym | bodyweight

# –ü–£–õ –î–û–°–¢–£–ü–ù–´–• –£–ü–†–ê–ñ–ù–ï–ù–ò–ô (–ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ –¢–û–õ–¨–ö–û –ò–•, –Ω–∞–∑–≤–∞–Ω–∏—è 1-–≤-1)
exercise_pool = {exercise_pool_json}
# –°—Ç—Ä—É–∫—Ç—É—Ä–∞:
# {{
#   "–ì—Ä—É–¥—å": ["–ñ–∏–º —à—Ç–∞–Ω–≥–∏ –ª—ë–∂–∞", ...],
#   "–°–ø–∏–Ω–∞": ["–¢—è–≥–∞ —à—Ç–∞–Ω–≥–∏ –≤ –Ω–∞–∫–ª–æ–Ω–µ", ...],
#   "–ù–æ–≥–∏": [...],
#   "–ü–ª–µ—á–∏": [...],
#   "–ë–∏—Ü–µ–ø—Å": [...],
#   "–¢—Ä–∏—Ü–µ–ø—Å": [...],
#   "–ò–∫—Ä—ã": [...]
# }}

# –ñ–Å–°–¢–ö–ò–ï –ü–†–ê–í–ò–õ–ê
1) **–í—ã–±–æ—Ä —Å–ø–ª–∏—Ç–∞ (—Å—Ç—Ä–æ–≥–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º):**
   –°–Ω–∞—á–∞–ª–∞ –æ–ø—Ä–µ–¥–µ–ª–∏ —Å–ø–ª–∏—Ç –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –¥–Ω–µ–π (`weekly_sessions`), –∑–∞—Ç–µ–º –ø–æ —É—Ä–æ–≤–Ω—é (`experience`).

   –∞) **–ï—Å–ª–∏ `weekly_sessions` = 5:**
      - **–í—Å–µ–≥–¥–∞** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 5-–¥–Ω–µ–≤–Ω—ã–π —Å–ø–ª–∏—Ç (–î–µ–Ω—å 1: –ì—Ä—É–¥—å; –î–µ–Ω—å 2: –°–ø–∏–Ω–∞; –î–µ–Ω—å 3: –ù–æ–≥–∏; –î–µ–Ω—å 4: –ü–ª–µ—á–∏; –î–µ–Ω—å 5: –†—É–∫–∏). –£—Ä–æ–≤–µ–Ω—å `experience` –Ω–µ –∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è.

   –±) **–ï—Å–ª–∏ `weekly_sessions` = 3:**
      - –ï—Å–ª–∏ `experience` = "–Ω–æ–≤–∏—á–æ–∫" -> **FullBody**.
      - –ï—Å–ª–∏ `experience` = "—Å—Ä–µ–¥–Ω–∏–π" –∏–ª–∏ "–ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π" -> **PPL (Push/Pull/Legs)**.
         - Push-–¥–µ–Ω—å: –ì—Ä—É–¥—å, –ü–ª–µ—á–∏, –¢—Ä–∏—Ü–µ–ø—Å.
         - Pull-–¥–µ–Ω—å: –°–ø–∏–Ω–∞, –ë–∏—Ü–µ–ø—Å.
         - Legs-–¥–µ–Ω—å: –ù–æ–≥–∏, –ò–∫—Ä—ã.

   –≤) **–ï—Å–ª–∏ `weekly_sessions` = 2:**
      - –ï—Å–ª–∏ `experience` = "–Ω–æ–≤–∏—á–æ–∫" -> **FullBody**.
      - –ï—Å–ª–∏ `experience` = "—Å—Ä–µ–¥–Ω–∏–π" –∏–ª–∏ "–ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π" -> **–í–µ—Ä—Ö/–ù–∏–∑ (Upper/Lower)**.
         - –î–µ–Ω—å –≤–µ—Ä—Ö–∞: –ì—Ä—É–¥—å, –°–ø–∏–Ω–∞, –ü–ª–µ—á–∏, –ë–∏—Ü–µ–ø—Å, –¢—Ä–∏—Ü–µ–ø—Å.
         - –î–µ–Ω—å –Ω–∏–∑–∞: –ù–æ–≥–∏, –ò–∫—Ä—ã.
   
   - –ú–∞–ª—ã–µ –º—ã—à–µ—á–Ω—ã–µ –≥—Ä—É–ø–ø—ã —Å—Ç–∞–≤–∏—Ç—å –≤ –¥–µ–Ω—å —Å–∏–Ω–µ—Ä–≥–∏—Å—Ç–∞ (–±–∏—Ü–µ–ø—Å ‚Äî —Å–æ —Å–ø–∏–Ω–æ–π/Pull; —Ç—Ä–∏—Ü–µ–ø—Å ‚Äî —Å –≥—Ä—É–¥—å—é/Push; –∑–∞–¥–Ω—è—è –¥–µ–ª—å—Ç–∞ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ Pull).
2) –ù–µ–¥–µ–ª—å–Ω—ã–µ –∫–æ—Ä–∏–¥–æ—Ä—ã –ø–æ–¥—Ö–æ–¥–æ–≤:
   - –ë–û–õ–¨–®–ò–ï (–≥—Ä—É–¥—å, —Å–ø–∏–Ω–∞, –Ω–æ–≥–∏):
     –Ω–æ–≤–∏—á–æ–∫ 6‚Äì8; —Å—Ä–µ–¥–Ω–∏–π 8‚Äì10; –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π 10‚Äì15 —Å–µ—Ç–æ–≤ –≤ –Ω–µ–¥–µ–ª—é.
   - –ú–ê–õ–´–ï (–ø–ª–µ—á–∏, –±–∏—Ü–µ–ø—Å, —Ç—Ä–∏—Ü–µ–ø—Å, –∏–∫—Ä—ã):
     –Ω–æ–≤–∏—á–æ–∫ 4‚Äì5; —Å—Ä–µ–¥–Ω–∏–π 6; –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π 6‚Äì9 —Å–µ—Ç–æ–≤ –≤ –Ω–µ–¥–µ–ª—é.
3) –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–±—ä—ë–º–∞ –ø–æ —Å–µ—Å—Å–∏—è–º:
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥—Ö–æ–¥–æ–≤ –≤ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è—Ö –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ —Ä–∞–∑–±–∏—Ç—ã –ø–æ –¥–Ω—è–º
   - –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –ø–æ –¥–Ω—è–º, —Ç–æ —Å–Ω–∞—á–∞–ª–∞ –ª—É—á—à–µ –≤ –æ–¥–∏–Ω –¥–µ–Ω—å –∫–∞–∫ –æ–±—ã—á–Ω–æ, –≤ —Å–ª–µ–¥—É—é—â–∏–π —á—É—Ç—å –º–µ–Ω—å—à–µ.
   - FullBody: –Ω–∞ –∫–∞–∂–¥–æ–π —Å–µ—Å—Å–∏–∏ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ–º –í–°–ï –≥—Ä—É–ø–ø—ã.
   - PPL: –∫–∞–∂–¥–∞—è –∫—Ä—É–ø–Ω–∞—è –≥—Ä—É–ø–ø–∞ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–≤–æ–π –Ω–µ–¥–µ–ª—å–Ω—ã–π –æ–±—ä—ë–º –≤ —Å–≤–æ—ë–º –¥–Ω–µ (Push/ Pull/ Legs); –º–∞–ª—ã–µ ‚Äî –≤ –¥–µ–Ω—å —Å–∏–Ω–µ—Ä–≥–∏—Å—Ç–∞.
   - 5-–¥–Ω–µ–≤–∫–∞: –∫–∞–∂–¥–∞—è –≥—Ä—É–ø–ø–∞ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–≤–æ–π –Ω–µ–¥–µ–ª—å–Ω—ã–π –æ–±—ä—ë–º –≤ —Å–≤–æ–π –¥–µ–Ω—å (–ì—Ä—É–¥—å/–°–ø–∏–Ω–∞/–ù–æ–≥–∏/–ü–ª–µ—á–∏/–†—É–∫–∏).
4) –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ —Å–µ—Å—Å–∏–∏:
   - –ù–∞ –û–î–ù–£ –∫—Ä—É–ø–Ω—É—é –≥—Ä—É–ø–ø—É –≤ –¥–µ–Ω—å ‚â§ 12 –ø–æ–¥—Ö–æ–¥–æ–≤ (–ª–∏—à–Ω–µ–µ —É—Ä–µ–∑–∞—Ç—å, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –±–∞–∑–æ–≤—ã–µ).
   - –£ –Ω–æ–≤–∏—á–∫–∞ –º–∞–∫—Å–∏–º—É–º 3 –ø–æ–¥—Ö–æ–¥–∞ –≤ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–∏.
   - –ù–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –æ—Ç 2 –¥–æ 4 –ø–æ–¥—Ö–æ–¥–∞.
   - **–°–ê–ú–û–ï –ì–õ–ê–í–ù–û–ï –ü–†–ê–í–ò–õ–û:** –í –ª—é–±–æ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ú–ò–ù–ò–ú–£–ú 2 –ø–æ–¥—Ö–æ–¥–∞. –ï—Å–ª–∏ –ø—Ä–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –æ–±—ä—ë–º–∞ –Ω–∞ –∫–∞–∫–æ–π-—Ç–æ –¥–µ–Ω—å –≤—ã–ø–∞–¥–∞–µ—Ç 1 –ø–æ–¥—Ö–æ–¥, –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —É–≤–µ–ª–∏—á—å –µ–≥–æ –¥–æ 2, –¥–∞–∂–µ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ–º–Ω–æ–≥–æ –ø—Ä–µ–≤—ã—Å–∏—Ç –Ω–µ–¥–µ–ª—å–Ω—ã–π –∫–æ—Ä–∏–¥–æ—Ä –ø–æ –æ–±—ä—ë–º—É. –ù–µ–¥–µ–ª—å–Ω—ã–π –∫–æ—Ä–∏–¥–æ—Ä ‚Äî —ç—Ç–æ –æ—Ä–∏–µ–Ω—Ç–∏—Ä, –∞ –ø—Ä–∞–≤–∏–ª–æ "–º–∏–Ω–∏–º—É–º 2 –ø–æ–¥—Ö–æ–¥–∞" ‚Äî –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –∑–∞–∫–æ–Ω.
   - –ï—Å–ª–∏ –Ω–∞ –º–∞–ª—É—é –≥—Ä—É–ø–ø—É –∑–∞ –ù–ï–î–ï–õ–Æ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ ‚â•6 –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Äî –≤ —Å—É–º–º–µ –Ω–µ–¥–µ–ª–∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 2 –†–ê–ó–ù–´–• —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –Ω–∞ —ç—Ç—É –≥—Ä—É–ø–ø—É.
   - –õ–∏–º–∏—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –≤ –¥–µ–Ω—å:
       * FullBody / PPL: –º–∞–∫—Å–∏–º—É–º 6 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π;
       * 5-–¥–Ω–µ–≤–∫–∞: 3‚Äì5 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π.
   - –°—É–ø–µ—Ä—Å–µ—Ç—ã –∑–∞–ø—Ä–µ—â–µ–Ω—ã.
5) –ü–æ–≤—Ç–æ—Ä—ã –ø–æ —Ü–µ–ª–∏:
   - ¬´–ø–æ—Ö—É–¥–µ–Ω–∏–µ¬ª: 10‚Äì15 (–∏–∑–æ–ª—è—Ü–∏–∏ –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è 12‚Äì20);
   - ¬´–Ω–∞–±–æ—Ä¬ª: 8‚Äì12;
   - ¬´–ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ¬ª: 6‚Äì12.
   AMRAP —Ä–∞–∑—Ä–µ—à—ë–Ω –¢–û–õ–¨–ö–û –µ—Å–ª–∏ equipment = "—Å–≤–æ–π –≤–µ—Å"; –∏–Ω–∞—á–µ ‚Äî —Ç–æ–ª—å–∫–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π.
6) –ù–∞–∑–≤–∞–Ω–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –≤—ã–±–∏—Ä–∞—Ç—å –°–¢–†–û–ì–û –∏–∑ exercise_pool. –ù–æ–≤—ã–µ –ø—Ä–∏–¥—É–º—ã–≤–∞—Ç—å –∑–∞–ø—Ä–µ—â–µ–Ω–æ.
   –ï—Å–ª–∏ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç, –æ–±—ä—ë–º –û–ö–†–£–ì–õ–Ø–ï–ú –í–ù–ò–ó, —Å–æ—Ö—Ä–∞–Ω—è—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –±–∞–∑–æ–≤—ã—Ö; –ø—Ä–∞–≤–∏–ª–æ 3‚Äì4 –ø–æ–¥—Ö–æ–¥–∞ –Ω–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ.
7) –í—Å–µ –≥—Ä—É–ø–ø—ã (–≤–∫–ª—é—á–∞—è –∏–∫—Ä—ã) –¥–æ–ª–∂–Ω—ã —Å—É–º–º–∞—Ä–Ω–æ –∑–∞ –Ω–µ–¥–µ–ª—é –ø–æ–ø–∞—Å—Ç—å –≤ —Å–≤–æ–π –∫–æ—Ä–∏–¥–æ—Ä –ø–æ –æ–±—ä—ë–º—É –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏.
8) –ï—Å–ª–∏ weekly_sessions = 2 –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å—Ä–µ–¥–Ω–∏–π/–ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ø–æ–¥ ¬´–Ω–∞–±–æ—Ä¬ª, –æ—Å—Ç–∞—ë–º—Å—è –Ω–∞ FullBody√ó2.

# –§–û–†–ú–ê–¢ –í–´–í–û–î–ê (–°–¢–†–û–ì–ò–ô JSON)
–í–µ—Ä–Ω–∏ —Ä–æ–≤–Ω–æ —Ç–∞–∫–æ–π JSON:
{{
  "sessions": [
    {{
      "session": 1,
      "exercises": [
        {{ "name": "<—Å—Ç—Ä–æ–≥–æ –∏–∑ exercise_pool>", "muscle_group": "<–≥—Ä—É–ø–ø–∞ –º—ã—à—Ü –∏–∑ exercise_pool>", "sets": <—Ü–µ–ª–æ–µ>, "reps": "<–∏–Ω—Ç–µ—Ä–≤–∞–ª –≤–∏–¥–∞ 8-12 | 10-15 | 12-20 | AMRAP>" }}
        // 4‚Äì6 —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è FullBody/PPL, 3‚Äì5 –¥–ª—è 5-–¥–Ω–µ–≤–∫–∏
      ]
    }},
    {{
      "session": 2,
      "exercises": [ ... ]
    }}
    // ... –¥–æ session = {{weekly_sessions}}
  ]
}}

# –¢–û–õ–¨–ö–û JSON. –ù–∏–∫–∞–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏ –ø–æ—è—Å–Ω–µ–Ω–∏–π.
"""


def load_and_prepare_exercises(equipment_type: str) -> dict:
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∏–∑ JSON, —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ —Ç–∏–ø—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
    –∏ –ø–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞.
    """
    with open("exercises_by_muscle_and_type.json", "r", encoding="utf-8") as f:
        all_exercises = json.load(f)

    # –°–æ–∑–¥–∞–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å —Å –ø–ª–æ—Å–∫–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
    filtered_exercises = {}
    equipment_map = {
        "gym": "–ó–∞–ª",
        "bodyweight": "–°–≤–æ–π –≤–µ—Å"
    }
    equipment_key = equipment_map.get(equipment_type)

    if not equipment_key:
        print(f"–û—à–∏–±–∫–∞: –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è '{equipment_type}'")
        return {}

    for muscle, groups in all_exercises.items():
        if equipment_key in groups:
            filtered_exercises[muscle] = groups[equipment_key]
        # –î–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º—ã—à–µ—á–Ω—ã—Ö –≥—Ä—É–ø–ø –º–æ–≥—É—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —Å–æ —Å–≤–æ–∏–º –≤–µ—Å–æ–º.
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∏—Ö, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –ø—É—Å—Ç—ã–µ —Å–ø–∏—Å–∫–∏.
        elif muscle in ["–ü–ª–µ—á–∏", "–ë–∏—Ü–µ–ø—Å", "–¢—Ä–∏—Ü–µ–ø—Å"] and equipment_type == "bodyweight":
            pass

    return filtered_exercises


def prepare_user_data_for_prompt(user: dict) -> dict:
    """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞."""
    goal_map = {
        "mass_gain": "–Ω–∞–±–æ—Ä",
        "weight_loss": "–ø–æ—Ö—É–¥–µ–Ω–∏–µ",
        "maintenance": "–ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ",
    }
    experience_map = {
        "beginner": "–Ω–æ–≤–∏—á–æ–∫",
        "intermediate": "—Å—Ä–µ–¥–Ω–∏–π",
        "advanced": "–ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π",
    }
    return {
        "goal": goal_map.get(user["goal"], "–ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ"),
        "experience": experience_map.get(user["fitness_level"], "–Ω–æ–≤–∏—á–æ–∫"),
        "weekly_sessions": user["workout_frequency"],
        "equipment": user["equipment_type"],
    }


async def generate_workout_week(user: dict, exercises: dict) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ù–ï–î–ï–õ–¨–ù–£–Æ –ø—Ä–æ–≥—Ä–∞–º–º—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ —Å –ø–æ–º–æ—â—å—é LLM.
    """
    user_params = prepare_user_data_for_prompt(user)
    exercise_pool_json = json.dumps(exercises, ensure_ascii=False, indent=2)

    prompt = WORKOUT_WEEK_JSON_PROMPT.format(
        goal=user_params["goal"],
        experience=user_params["experience"],
        weekly_sessions=user_params["weekly_sessions"],
        equipment=user_params["equipment"],
        exercise_pool_json=exercise_pool_json,
    )

    print("üì§ –û–¢–ü–†–ê–í–ö–ê –ó–ê–ü–†–û–°–ê –í LLM...")
    # print(prompt) # –ú–æ–∂–Ω–æ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –ø—Ä–æ–º–ø—Ç–∞

    chat_completion = await client.chat.completions.create(
        model="gpt-4.1-mini",
        messages=[{"role": "user", "content": prompt}],
        response_format={"type": "json_object"},
        temperature=0.4,
        timeout=180.0,
    )

    print("‚úÖ –ó–ê–ü–†–û–° –£–°–ü–ï–®–ù–û –í–´–ü–û–õ–ù–ï–ù!")
    return chat_completion.choices[0].message.content


async def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–µ–¥–µ–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã"""
    print("ü§ñ –ù–∞—á–∏–Ω–∞—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –Ω–µ–¥–µ–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫...")

    exercises = load_and_prepare_exercises(TEST_USER["equipment_type"])

    try:
        workout_json_str = await generate_workout_week(
            user=TEST_USER,
            exercises=exercises,
        )

        workout_data = json.loads(workout_json_str)

        print("\n" + "="*80)
        print("‚úÖ –í–ê–®–ê –ü–†–û–ì–†–ê–ú–ú–ê –¢–†–ï–ù–ò–†–û–í–û–ö –ù–ê –ù–ï–î–ï–õ–Æ –ì–û–¢–û–í–ê!")
        print("="*80)
        print(json.dumps(workout_data, indent=2, ensure_ascii=False))

    except Exception as e:
        print("\n" + "="*80)
        print(f"‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ü–†–ò –ì–ï–ù–ï–†–ê–¶–ò–ò: {e}")
        print("="*80)


if __name__ == "__main__":
    asyncio.run(main())

