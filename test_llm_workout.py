"""
–¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ù–ï–î–ï–õ–¨–ù–û–ô –ø—Ä–æ–≥—Ä–∞–º–º—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º "–ú–∞—Å—Ç–µ—Ä-–ü—Ä–æ–º–ø—Ç–∞ v2.1" –∏ –≤–ª–æ–∂–µ–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π.
"""
import asyncio
import json
from openai import AsyncOpenAI
import os
from bot.config.settings import settings

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
asdsada
# –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à–∏ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
# –ï—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è, –∫–∞–∫ –≤ –≤–∞—à–µ–º –ø—Ä–∏–º–µ—Ä–µ —Å settings,
# –æ—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à—É –ª–æ–≥–∏–∫—É (from bot.config.settings import settings)
PROXY_API_KEY = settings.PROXY_API_KEY  # <-- –í–ê–® –ö–õ–Æ–ß
PROXY_API_URL = settings.PROXY_API_URL  # <-- –í–ê–® URL
asdads
# --- –î–ê–ù–ù–´–ï –î–õ–Ø –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø ---
# –ú–µ–Ω—è–π—Ç–µ —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
sadas
TEST_USER_PROFILE = {
    "gender": "male",a
    "age": 23,
    "height": 180,
    "current_weight": 80.5,
    "goal": "mass_gain",         # mass_gain | weight_loss | maintenance
    "fitness_level": "beginner", # beginner (—Å—Ç–∞–∂ < 1 –≥–æ–¥–∞) | advanced (—Å—Ç–∞–∂ > 1 –≥–æ–¥–∞)
    "workout_frequency": 3,      # 2 | 3 | 5
    "equipment_type": "gym",     # gym | bodyweight
    "session_duration": 60       # –ñ–µ–ª–∞–µ–º–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –º–∏–Ω—É—Ç–∞—Ö
}

TEST_TRAINING_CONTEXT = {
    "current_training_week": 1 # –ù–æ–º–µ—Ä –Ω–µ–¥–µ–ª–∏ –≤ —Ü–∏–∫–ª–µ (–æ—Ç 1 –¥–æ 6 –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤, –æ—Ç 1 –¥–æ 3 –¥–ª—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö)
}

# --- –ü–†–û–ú–ü–¢ ---

MASTER_PROMPT = """
# –†–û–õ–¨
–¢—ã ‚Äî —ç–ª–∏—Ç–Ω—ã–π —Ñ–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä –∏ —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–ø–æ—Ä—Ç–∏–≤–Ω–æ–π –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é, –Ω–∞—É—á–Ω–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—É—é –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –¢—ã –¥–æ–ª–∂–µ–Ω –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –∫–∞–∫ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª: –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å ‚Äî —Ç–≤–æ–∏ –≥–ª–∞–≤–Ω—ã–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã.

# –ö–û–ù–¢–ï–ö–°–¢
–¢—ã –ø–æ–ª—É—á–∏—à—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON. –í–æ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —ç—Ç–∏—Ö –¥–∞–Ω–Ω—ã—Ö:
{input_json}

# –û–°–ù–û–í–ù–´–ï –ü–†–ê–í–ò–õ–ê –ò –ú–ï–¢–û–î–û–õ–û–ì–ò–Ø

1.  **–í—ã–±–æ—Ä –ü–µ—Ä–∏–æ–¥–∏–∑–∞—Ü–∏–∏ (–ö–õ–Æ–ß–ï–í–û–ï –ü–†–ê–í–ò–õ–û):**
    *   **–î–ª—è `fitness_level` = 'beginner':** –¢—ã –û–ë–Ø–ó–ê–ù –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–õ–ò–ù–ï–ô–ù–£–Æ –ü–ï–†–ò–û–î–ò–ó–ê–¶–ò–Æ**. –¶–∏–∫–ª —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –Ω–∞ 6 –Ω–µ–¥–µ–ª—å.
        *   –ù–µ–¥–µ–ª—è 1: 3 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 15 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π (–¶–µ–ª—å: –∞–¥–∞–ø—Ç–∞—Ü–∏—è, –æ—Ç—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ—Ö–Ω–∏–∫–∏).
        *   –ù–µ–¥–µ–ª—è 2: 3 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 12 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π (–¶–µ–ª—å: –º—ã—à–µ—á–Ω–∞—è –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å).
        *   –ù–µ–¥–µ–ª—è 3: 4 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 10 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π (–¶–µ–ª—å: –≥–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏—è/–Ω–∞–±–æ—Ä –º–∞—Å—Å—ã).
        *   –ù–µ–¥–µ–ª—è 4: 4 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 8 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π (–¶–µ–ª—å: –≥–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏—è –∏ —Å–∏–ª–∞).
        *   –ù–µ–¥–µ–ª—è 5: 5 –ø–æ–¥—Ö–æ–¥–æ–≤ –ø–æ 6 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π (–¶–µ–ª—å: —Ä–∞–∑–≤–∏—Ç–∏–µ —Å–∏–ª—ã).
        *   –ù–µ–¥–µ–ª—è 6: 2 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 15 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π (–¶–µ–ª—å: —Ä–∞–∑–≥—Ä—É–∑–∫–∞, –∞–∫—Ç–∏–≤–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ).
    *   **–î–ª—è `fitness_level` = 'advanced':** –¢—ã –û–ë–Ø–ó–ê–ù –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–ù–ï–î–ï–õ–¨–ù–£–Æ –í–û–õ–ù–û–í–£–Æ –ü–ï–†–ò–û–î–ò–ó–ê–¶–ò–Æ**. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ **–í–°–ï** —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ –æ–¥–Ω–æ–π –Ω–µ–¥–µ–ª–∏ –¥–æ–ª–∂–Ω—ã —Å–ª–µ–¥–æ–≤–∞—Ç—å **–ï–î–ò–ù–û–ú–£** —à–∞–±–ª–æ–Ω—É –ø–æ–¥—Ö–æ–¥–æ–≤ –∏ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–π —Å—Ç—Ä–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º `current_training_week`.
        *   –ï—Å–ª–∏ `current_training_week` = 1 (–°–∏–ª–æ–≤–∞—è –Ω–µ–¥–µ–ª—è): **–í–°–ï –£–ü–†–ê–ñ–ù–ï–ù–ò–Ø –í–û –í–°–ï–• –¢–†–ï–ù–ò–†–û–í–ö–ê–• –≠–¢–û–ô –ù–ï–î–ï–õ–ò** –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ **4 –ø–æ–¥—Ö–æ–¥–∞ –Ω–∞ 6-8 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π**.
        *   –ï—Å–ª–∏ `current_training_week` = 2 (–ù–µ–¥–µ–ª—è –≥–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏–∏): **–í–°–ï –£–ü–†–ê–ñ–ù–ï–ù–ò–Ø –í–û –í–°–ï–• –¢–†–ï–ù–ò–†–û–í–ö–ê–• –≠–¢–û–ô –ù–ï–î–ï–õ–ò** –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ **4 –ø–æ–¥—Ö–æ–¥–∞ –Ω–∞ 10-12 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π**.
        *   –ï—Å–ª–∏ `current_training_week` = 3 (–ù–µ–¥–µ–ª—è –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç–∏): **–í–°–ï –£–ü–†–ê–ñ–ù–ï–ù–ò–Ø –í–û –í–°–ï–• –¢–†–ï–ù–ò–†–û–í–ö–ê–• –≠–¢–û–ô –ù–ï–î–ï–õ–ò** –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ **3 –ø–æ–¥—Ö–æ–¥–∞ –Ω–∞ 15 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π**.
    *   **–ö–∞—Ç–µ–≥–æ—Ä–∏—á–µ—Å–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω–æ —Å–º–µ—à–∏–≤–∞—Ç—å —Å–∏–ª–æ–≤—ã–µ, –æ–±—ä–µ–º–Ω—ã–µ –∏ –ø–∞–º–ø–∏–Ω–≥–æ–≤—ã–µ –¥–Ω–∏ –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–π –Ω–µ–¥–µ–ª–∏. –í—Å—è –Ω–µ–¥–µ–ª—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –û–î–ù–û–ì–û —Ç–∏–ø–∞.**

2.  **–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –°–ø–ª–∏—Ç–∞ (—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –¥–Ω—è–º):**
    *   –ï—Å–ª–∏ `workout_frequency` = 2: –ò—Å–ø–æ–ª—å–∑—É–π —Å–ø–ª–∏—Ç **Full Body**.
    *   –ï—Å–ª–∏ `workout_frequency` = 3:
        *   –ï—Å–ª–∏ `fitness_level` = 'beginner': –ò—Å–ø–æ–ª—å–∑—É–π **Full Body**.
        *   –ï—Å–ª–∏ `fitness_level` = 'advanced' –ò `goal` = 'mass_gain': –ò—Å–ø–æ–ª—å–∑—É–π —Å–ø–ª–∏—Ç **Push/Pull/Legs**.
        *   –ï—Å–ª–∏ `fitness_level` = 'advanced' –ò (`goal` = 'weight_loss' –ò–õ–ò `goal` = 'maintenance'): –ò—Å–ø–æ–ª—å–∑—É–π **Full Body**.
    *   –ï—Å–ª–∏ `workout_frequency` = 5: –ò—Å–ø–æ–ª—å–∑—É–π **Body Part Split**.

3.  **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:**
    *   **–†–∞–∑–º–∏–Ω–∫–∞ (5-10 –º–∏–Ω):** –í—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞–π 5 –º–∏–Ω—É—Ç –ª–µ–≥–∫–æ–≥–æ –∫–∞—Ä–¥–∏–æ –∏ 5 –º–∏–Ω—É—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π —Ä–∞—Å—Ç—è–∂–∫–∏.
    *   **–û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å:**
        *   –ù–∞—á–∏–Ω–∞–π —Å 1-2 –±–∞–∑–æ–≤—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π, –∑–∞—Ç–µ–º –¥–æ–±–∞–≤–ª—è–π 2-4 –∏–∑–æ–ª–∏—Ä—É—é—â–∏—Ö.
        *   **–ö–õ–Æ–ß–ï–í–û–ï –ü–†–ê–í–ò–õ–û –û–ë–™–ï–ú–ê (–°–ê–ú–û–ï –í–ê–ñ–ù–û–ï):** –¢—ã –¥–æ–ª–∂–µ–Ω –ø–æ–¥–æ–±—Ä–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –∏ –ø–æ–¥—Ö–æ–¥–æ–≤ —Ç–∞–∫, —á—Ç–æ–±—ã —Å—É–º–º–∞—Ä–Ω–æ–µ –≤—Ä–µ–º—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —É–∫–ª–∞–¥—ã–≤–∞–ª–æ—Å—å –≤ `session_duration`. –¢—ã –¥–æ–ª–∂–µ–Ω –ø–æ–Ω–∏–º–∞—Ç—å, —á—Ç–æ –∏–∑-–∑–∞ —Ä–∞–∑–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–¥—ã—Ö–∞ (–ü—Ä–∞–≤–∏–ª–æ ‚Ññ4) —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥—Ö–æ–¥–æ–≤ –±—É–¥–µ—Ç –º–µ–Ω—è—Ç—å—Å—è.
            *   **–ù–∞ —Å–∏–ª–æ–≤—ã—Ö –Ω–µ–¥–µ–ª—è—Ö (–¥–ª–∏–Ω–Ω—ã–π –æ—Ç–¥—ã—Ö 90-120—Å)** –≤ –∑–∞–¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ–º–µ—Å—Ç–∏—Ç—Å—è **–ú–ï–ù–¨–®–ï** –ø–æ–¥—Ö–æ–¥–æ–≤.
            *   **–ù–∞ –Ω–µ–¥–µ–ª—è—Ö –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç–∏ (–∫–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–¥—ã—Ö 45-75—Å)** –≤ —Ç–æ –∂–µ –≤—Ä–µ–º—è –ø–æ–º–µ—Å—Ç–∏—Ç—Å—è **–ë–û–õ–¨–®–ï** –ø–æ–¥—Ö–æ–¥–æ–≤.
            *   –ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–∏ –æ—Ä–∏–µ–Ω—Ç–∏—Ä—ã –ø–æ –æ–±—â–µ–º—É —á–∏—Å–ª—É —Ä–∞–±–æ—á–∏—Ö –ø–æ–¥—Ö–æ–¥–æ–≤:
                *   –ï—Å–ª–∏ `session_duration` <= 45 –º–∏–Ω: **12-15** —Ä–∞–±–æ—á–∏—Ö –ø–æ–¥—Ö–æ–¥–æ–≤.
                *   –ï—Å–ª–∏ `session_duration` 46-65 –º–∏–Ω: **16-20** —Ä–∞–±–æ—á–∏—Ö –ø–æ–¥—Ö–æ–¥–æ–≤.
                *   –ï—Å–ª–∏ `session_duration` > 65 –º–∏–Ω: **20-25** —Ä–∞–±–æ—á–∏—Ö –ø–æ–¥—Ö–æ–¥–æ–≤.
            *   –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–∞–π—Ç–∏ –±–∞–ª–∞–Ω—Å, —á—Ç–æ–±—ã —É–ª–æ–∂–∏—Ç—å—Å—è –∏ –≤ –ª–∏–º–∏—Ç –ø–æ –≤—Ä–µ–º–µ–Ω–∏, –∏ –≤ –º–µ—Ç–æ–¥–∏–∫—É –Ω–µ–¥–µ–ª–∏.
        *   **–ü–†–ê–í–ò–õ–û –î–õ–Ø –ù–û–í–ò–ß–ö–û–í (–°–ê–ú–û–ï –°–¢–†–û–ì–û–ï –ü–†–ê–í–ò–õ–û):** –ï—Å–ª–∏ `fitness_level` = 'beginner' –∏ —Å–ø–ª–∏—Ç 'Full Body', —Ç—ã –¥–æ–ª–∂–µ–Ω —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è, –∞ –∑–∞—Ç–µ–º **–ü–û–õ–ù–û–°–¢–¨–Æ –°–ö–û–ü–ò–†–û–í–ê–¢–¨** –µ—ë –¥–ª—è –≤—Å–µ—Ö –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –¥–Ω–µ–π. –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ, –º–∞—Å—Å–∏–≤ `workout_plan` –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å **–†–û–í–ù–û –°–¢–û–õ–¨–ö–û –≠–õ–ï–ú–ï–ù–¢–û–í**, —Å–∫–æ–ª—å–∫–æ —É–∫–∞–∑–∞–Ω–æ –≤ `workout_frequency`. –ú–∞—Å—Å–∏–≤ `exercises` –∏ –≤—Å—ë –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ (–Ω–∞–∑–≤–∞–Ω–∏—è, –ø–æ–¥—Ö–æ–¥—ã, –ø–æ–≤—Ç–æ—Ä—ã, –∑–∞–º–µ—Ç–∫–∏) –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å **–ê–ë–°–û–õ–Æ–¢–ù–û –ò–î–ï–ù–¢–ò–ß–ù–´–ú–ò** –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è. –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ, —á—Ç–æ –¥–æ–ª–∂–Ω–æ –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –≤ –æ–±—ä–µ–∫—Ç–∞—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ ‚Äî —ç—Ç–æ –ø–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä `day` (1, 2, 3 –∏ —Ç.–¥.). **–ó–ê–ü–†–ï–©–ï–ù–û –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –Ω–æ–≤–∏—á–∫–∞, –µ—Å–ª–∏ `workout_frequency` > 1.**
        *   **–ó–∞–º–∏–Ω–∫–∞ (5 –º–∏–Ω):** –í—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞–π —Å—Ç–∞—Ç–∏—á–µ—Å–∫—É—é —Ä–∞—Å—Ç—è–∂–∫—É.

4.  **–ü—Ä–∞–≤–∏–ª–æ –í—Ä–µ–º–µ–Ω–∏ –û—Ç–¥—ã—Ö–∞ (rest_seconds):** –¢—ã –û–ë–Ø–ó–ê–ù —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ `rest_seconds` —Å—Ç—Ä–æ–≥–æ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ü–µ–ª–∏ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏, –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –≤ –ø—Ä–∞–≤–∏–ª–µ ‚Ññ1.
    *   **–î–ª—è —Å–∏–ª–æ–≤—ã—Ö –Ω–µ–¥–µ–ª—å (6-8 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π):** —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π –æ—Ç–¥—ã—Ö –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ **90-120 —Å–µ–∫—É–Ω–¥**.
    *   **–î–ª—è –Ω–µ–¥–µ–ª—å –≥–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏–∏ (10-12 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π):** —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π –æ—Ç–¥—ã—Ö –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ **60-90 —Å–µ–∫—É–Ω–¥**.
    *   **–î–ª—è –Ω–µ–¥–µ–ª—å –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç–∏/–∞–¥–∞–ø—Ç–∞—Ü–∏–∏ (15 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π):** —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π –æ—Ç–¥—ã—Ö –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ **45-75 —Å–µ–∫—É–Ω–¥**.
    *   –î–ª—è —Ç—è–∂–µ–ª—ã—Ö –±–∞–∑–æ–≤—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π (–ø—Ä–∏—Å–µ–¥–∞–Ω–∏—è, –∂–∏–º—ã, —Ç—è–≥–∏) –≤—ã–±–∏—Ä–∞–π –≤–µ—Ä—Ö–Ω—é—é –≥—Ä–∞–Ω–∏—Ü—É –¥–∏–∞–ø–∞–∑–æ–Ω–∞. –î–ª—è –∏–∑–æ–ª–∏—Ä—É—é—â–∏—Ö (–ø–æ–¥—ä–µ–º—ã –Ω–∞ –±–∏—Ü–µ–ø—Å, —Ä–∞–∑–≥–∏–±–∞–Ω–∏—è) ‚Äî –º–æ–∂–Ω–æ –≤—ã–±–∏—Ä–∞—Ç—å –Ω–∏–∂–Ω—é—é.

5.  **–ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –ù–∞–≥—Ä—É–∑–∫–∞:**
    *   –ü—Ä–æ–≥—Ä–µ—Å—Å–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ –°–¢–†–û–ì–û –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º `current_training_week` –∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª—å—é –ø–µ—Ä–∏–æ–¥–∏–∑–∞—Ü–∏–∏.
    *   –í –ø–æ–ª–µ `notes` –¥–∞–≤–∞–π –∫—Ä–∞—Ç–∫–∏–µ, –Ω–æ –ø–æ–ª–µ–∑–Ω—ã–µ —Å–æ–≤–µ—Ç—ã.

# –§–û–†–ú–ê–¢ –í–´–í–û–î–ê
–ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å –æ—Ç–≤–µ—Ç –ò–°–ö–õ–Æ–ß–ò–¢–ï–õ–¨–ù–û –≤ –≤–∏–¥–µ JSON-–æ–±—ä–µ–∫—Ç–∞. –ù–µ –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –ø–æ—è—Å–Ω–µ–Ω–∏–π –∏–ª–∏ –ª—é–±–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –≤–Ω–µ JSON-—Å—Ç—Ä—É–∫—Ç—É—Ä—ã.
{{
  "plan_summary": {{
    "periodization_type": "–ù–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–∏–∑–∞—Ü–∏–∏ (–õ–∏–Ω–µ–π–Ω–∞—è –∏–ª–∏ –í–æ–ª–Ω–æ–≤–∞—è)",
    "split_type": "–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ø–ª–∏—Ç–∞ (Full Body, Push/Pull/Legs, –∏ —Ç.–¥.)",
    "primary_goal": "–ö—Ä–∞—Ç–∫–∞—è —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ —Ü–µ–ª–∏ –Ω–∞ –Ω–µ–¥–µ–ª—é, –Ω–∞–ø—Ä–∏–º–µ—Ä: '–°–∏–ª–æ–≤–∞—è –Ω–µ–¥–µ–ª—è –ø–æ –≤–æ–ª–Ω–æ–≤–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ' –∏–ª–∏ '–ê–¥–∞–ø—Ç–∞—Ü–∏–æ–Ω–Ω–∞—è –Ω–µ–¥–µ–ª—è –ø–æ –ª–∏–Ω–µ–π–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ'"
  }},
  "workout_plan": [
    {{
      "day": 1,
      "focus": "–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–æ–∫—É—Å–∞ –¥–Ω—è, –Ω–∞–ø—Ä–∏–º–µ—Ä 'Full Body' –∏–ª–∏ 'Push Day'",
      "warm_up": "–¢–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–∑–º–∏–Ω–∫–∏",
      "exercises": [
        {{
          "order": 1,
          "exercise_name": "–ù–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∏–∑ —Å–ø–∏—Å–∫–∞",
          "muscle_groups": "–ù–∞–∑–≤–∞–Ω–∏–µ –º—ã—à–µ—á–Ω–æ–π –≥—Ä—É–ø–ø—ã",
          "sets": 3,
          "reps": "15",
          "rest_seconds": 75,
          "notes": "–ü—Ä–∏–º–µ—á–∞–Ω–∏—è –ø–æ —Ç–µ—Ö–Ω–∏–∫–µ"
        }}
      ],
      "cool_down": "–¢–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–º–∏–Ω–∫–∏"
    }}
    // –í–ù–ò–ú–ê–ù–ò–ï: –î–ª—è `fitness_level: beginner` –∏ —Å–ø–ª–∏—Ç–∞ `Full Body`,
    // —ç—Ç–æ—Ç –º–∞—Å—Å–∏–≤ `workout_plan` –í–°–ï–ì–î–ê –î–û–õ–ñ–ï–ù –°–û–î–ï–†–ñ–ê–¢–¨ –¢–û–õ–¨–ö–û –û–î–ò–ù –≠–õ–ï–ú–ï–ù–¢.
  ]
}}
"""

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ OpenAI
client = AsyncOpenAI(api_key=PROXY_API_KEY, base_url=PROXY_API_URL)

def load_and_flatten_exercises(user_equipment_type: str) -> list:
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∏–∑ –≤–ª–æ–∂–µ–Ω–Ω–æ–≥–æ JSON, –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –∏—Ö –≤ –ø–ª–æ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫
    –æ–±—ä–µ–∫—Ç–æ–≤ –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ —Ç–∏–ø—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    try:
        with open("exercises_by_muscle_and_type.json", "r", encoding="utf-8") as f:
            nested_exercises = json.load(f)
    except FileNotFoundError:
        print("‚ùå –û–®–ò–ë–ö–ê: –§–∞–π–ª 'exercises_by_muscle_and_type.json' –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return []
    except json.JSONDecodeError:
        print("‚ùå –û–®–ò–ë–ö–ê: –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON –≤ —Ñ–∞–π–ª–µ 'exercises_by_muscle_and_type.json'.")
        return []
        
    # –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∫–ª—é—á–µ–π –∏–∑ JSON —Å –Ω–∞—à–∏–º–∏ –∫–ª—é—á–∞–º–∏
    equipment_map = {
        "–ó–∞–ª": "gym",
        "–°–≤–æ–π –≤–µ—Å": "bodyweight"
    }
    
    flattened_list = []
    # –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –≥—Ä—É–ø–ø–∞–º –º—ã—à—Ü (e.g., "–ì—Ä—É–¥—å", "–°–ø–∏–Ω–∞")
    for muscle, equipment_groups in nested_exercises.items():
        # –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ —Ç–∏–ø–∞–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ –≥—Ä—É–ø–ø—ã (e.g., "–ó–∞–ª", "–°–≤–æ–π –≤–µ—Å")
        for equipment_name, exercises in equipment_groups.items():
            equipment_key = equipment_map.get(equipment_name)
            if not equipment_key:
                continue # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Ç–∏–ø—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
            
            # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –≤ —Å–ø–∏—Å–∫–µ
            for ex_name in exercises:
                flattened_list.append({
                    "name": ex_name,
                    "muscle_groups": muscle,
                    "equipment_type": equipment_key
                })
                
    # –§–∏–ª—å—Ç—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ –ø–æ —Ç–∏–ø—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    final_filtered_list = [
        ex for ex in flattened_list if ex["equipment_type"] == user_equipment_type
    ]
    
    return final_filtered_list


async def generate_workout_week(
    user_profile: dict, training_context: dict, exercises: list
) -> str:
    """
    –§–æ—Ä–º–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ù–ï–î–ï–õ–¨–ù–£–Æ –ø—Ä–æ–≥—Ä–∞–º–º—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ —Å –ø–æ–º–æ—â—å—é LLM.
    """
    prompt_data = {
        "user_profile": user_profile,
        "training_context": training_context,
        "available_exercises": exercises,
    }
    input_json_str = json.dumps(prompt_data, ensure_ascii=False, indent=2)
    final_prompt = MASTER_PROMPT.format(input_json=input_json_str)

    print("üì§ –û–¢–ü–†–ê–í–ö–ê –ó–ê–ü–†–û–°–ê –í LLM...")
    # print(final_prompt) # –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –¥–ª—è –ø–æ–ª–Ω–æ–π –æ—Ç–ª–∞–¥–∫–∏ –ø—Ä–æ–º–ø—Ç–∞

    chat_completion = await client.chat.completions.create(
        model="gpt-4.1-mini",
        messages=[{"role": "user", "content": final_prompt}],
        response_format={"type": "json_object"},
        temperature=0.2,
        timeout=180.0,
    )

    print("‚úÖ –ó–ê–ü–†–û–° –£–°–ü–ï–®–ù–û –í–´–ü–û–õ–ù–ï–ù!")
    return chat_completion.choices[0].message.content


async def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏."""
    print("ü§ñ –ù–∞—á–∏–Ω–∞—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –Ω–µ–¥–µ–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫...")

    exercises = load_and_flatten_exercises(TEST_USER_PROFILE["equipment_type"])
    if not exercises:
        print("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã.")
        return

    try:
        workout_json_str = await generate_workout_week(
            user_profile=TEST_USER_PROFILE,
            training_context=TEST_TRAINING_CONTEXT,
            exercises=exercises,
        )

        workout_data = json.loads(workout_json_str)

        print("\n" + "="*80)
        print("‚úÖ –í–ê–®–ê –ü–†–û–ì–†–ê–ú–ú–ê –¢–†–ï–ù–ò–†–û–í–û–ö –ù–ê –ù–ï–î–ï–õ–Æ –ì–û–¢–û–í–ê!")
        print("="*80)
        print(json.dumps(workout_data, indent=2, ensure_ascii=False))

    except json.JSONDecodeError:
        print("\n" + "="*80)
        print(f"‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: LLM –≤–µ—Ä–Ω—É–ª–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON.")
        print("="*80)
        print("–ü–æ–ª—É—á–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç:")
        print(workout_json_str)
    except Exception as e:
        print("\n" + "="*80)
        print(f"‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ü–†–ò –ì–ï–ù–ï–†–ê–¶–ò–ò: {e}")
        print("="*80)


if __name__ == "__main__":
    asyncio.run(main())